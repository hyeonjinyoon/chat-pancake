@{
    ViewData["Title"] = "Chat";
}

<div style="width: 100%; max-width: 720px; padding: 5px; height: 100%; margin: 24px auto;">
    <div class="flex h-full w-full" style="width: 100%">
        <div style="color: #919191; width: fit-content; margin: 0 auto; align-items: center;">
            🥞o1-pro
        </div>
        <div id="tblContent" style="height: 100%; width: 100%; margin-bottom: 300px;">
        </div>

        <div style="position: fixed; bottom: 0; left: 0; width: 100%; align-items: center;">
            <div class="input-box-holder"
                 style="width: 100%; max-width: 720px; margin: 0 auto 46px; background: #2e2e2e;">
                <form onsubmit="SendInput(); return false;" style="width: 100%; height: 100%;">
                    <textarea class="input-box" id="input1" placeholder="> ..."
                              onkeydown="handleKeyDown(event)"></textarea>
                    <input type="submit" style="display: none;">
                </form>
            </div>
        </div>
    </div>
</div>

@section Scripts
{
    <script type="text/javascript">
        // Enter키: 송신, Shift+Enter: 줄바꿈 처리
        function handleKeyDown(e) {
            if (e.key === "Enter" && !e.shiftKey) {
                e.preventDefault();
                SendInput();
            }
        }

        function SendInput() {
            let typped = document.getElementById('input1').value;
            document.getElementById('input1').value = '';

            if (typped == "") {
                depth = 0;
                $('#input-tab').html("");
                return;
            }

            let chatId = crypto.randomUUID();

            $('#tblContent').append("<div id='chat-" + chatId + "' style='width: 100%;'>"
                + "<div id='question-" + chatId + "' style='margin-top: 8px; margin-left: auto; width: fit-content; max-width: 600px;" +
                "background-color: #303030; color: #ccc; padding: 9px; border-radius: 20px;" +
                "align-items: center; white-space: pre-wrap; overflow: auto;'>"
                + "</div>"
                + "<div style='width: 20px; height: 20px; margin-left: auto; color: #919191; cursor: pointer;' onclick=copyToClipboard('question-" + chatId + "')>"
                + "<svg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='currentColor' class='bi bi-copy' viewBox='0 0 16 16'>                <path fill-rule='evenodd' d='M4 2a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2zm2-1a1 1 0 0 0-1 1v8a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1zM2 5a1 1 0 0 0-1 1v8a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1v-1h1v1a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h1v1z'/></svg>"
                + "</div>"
                + "</div>");

            $('#question-' + chatId).text(typped.toString());

            $('#chat-' + chatId).append(
                "<div class='load-icon' id='load-" + chatId + "' style='margin-top: 8px; margin-right: auto; width: fit-content; max-width: 600px; background-color: #2b2b2b; color: #ccc; padding: 9px; border-radius: 20px; align-items: center;'>"
                + "🥞</div></div>");

            fetch('@Url.Action("ReceiveText")', {
                method: 'POST',
                credentials: 'include',
                headers: {
                    'Content-Type': 'application/json; charset=utf-8'
                },
                body: JSON.stringify({data: typped})
            })
                .then(response => {
                    if (!response.ok) {
                        $("load-" + chatId).append("response error");
                        throw new Error('네트워크 응답에 문제가 있습니다.');
                    }
                    return response.json();
                })
                .then(data => {
                    document.getElementById("load-" + chatId).remove();
                    $('#chat-' + chatId).append(data.html);
                    $('#' + data.answerId).text(data.content);
                })
                .catch(error => {
                    $("load-" + chatId).append("error<br>" + error.string());
                });
        }

        function copyToClipboard(id) {
            const textToCopy = document.getElementById(id).textContent;
            navigator.clipboard.writeText(textToCopy);
        }
    </script>
}
